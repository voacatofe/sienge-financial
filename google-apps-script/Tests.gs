/**
 * Tests.gs
 * Suite de Testes Unit√°rios para o Sienge Financial Connector
 *
 * Execute: testAll() para rodar todos os testes
 */

// ==========================================
// Test Runner Principal
// ==========================================

/**
 * Executa todos os testes e gera relat√≥rio
 */
function testAll() {
  Logger.log('='.repeat(60));
  Logger.log('üß™ INICIANDO SUITE DE TESTES');
  Logger.log('='.repeat(60));
  Logger.log('');

  var results = {
    total: 0,
    passed: 0,
    failed: 0,
    errors: []
  };

  // Executar todos os grupos de testes
  var testGroups = [
    { name: 'Config', fn: testConfigValidation },
    { name: 'URL Building', fn: testUrlBuilding },
    { name: 'Data Transformation', fn: testDataTransformation },
    { name: 'Field Mapping', fn: testFieldMapping },
    { name: 'Date Formatting', fn: testDateFormatting },
    { name: 'Cache Validation', fn: testCacheValidation },
    { name: 'Error Handling', fn: testErrorHandling },
    { name: 'Metrics Calculation', fn: testMetricsCalculation }
  ];

  testGroups.forEach(function(group) {
    Logger.log('üìã Testing: ' + group.name);
    try {
      var groupResult = group.fn();
      results.total += groupResult.total;
      results.passed += groupResult.passed;
      results.failed += groupResult.failed;

      if (groupResult.errors.length > 0) {
        results.errors = results.errors.concat(groupResult.errors);
      }

      Logger.log('   ‚úÖ Passed: ' + groupResult.passed + ' | ‚ùå Failed: ' + groupResult.failed);
    } catch (e) {
      results.failed++;
      results.errors.push(group.name + ': ' + e.message);
      Logger.log('   ‚ùå ERROR: ' + e.message);
    }
    Logger.log('');
  });

  // Relat√≥rio final
  Logger.log('='.repeat(60));
  Logger.log('üìä RELAT√ìRIO FINAL');
  Logger.log('='.repeat(60));
  Logger.log('Total de testes: ' + results.total);
  Logger.log('‚úÖ Passou: ' + results.passed);
  Logger.log('‚ùå Falhou: ' + results.failed);
  Logger.log('Taxa de sucesso: ' + ((results.passed / results.total) * 100).toFixed(1) + '%');

  if (results.errors.length > 0) {
    Logger.log('');
    Logger.log('‚ö†Ô∏è ERROS:');
    results.errors.forEach(function(error) {
      Logger.log('  ‚Ä¢ ' + error);
    });
  }

  Logger.log('');
  Logger.log(results.failed === 0 ? '‚úÖ TODOS OS TESTES PASSARAM!' : '‚ùå ALGUNS TESTES FALHARAM');
  Logger.log('='.repeat(60));

  return results;
}

// ==========================================
// Helper Functions
// ==========================================

function assert(condition, message) {
  if (!condition) {
    throw new Error('Assertion failed: ' + message);
  }
}

function assertEqual(actual, expected, message) {
  if (actual !== expected) {
    throw new Error('Expected "' + expected + '" but got "' + actual + '" - ' + message);
  }
}

// ==========================================
// Test Groups
// ==========================================

/**
 * Testa valida√ß√£o de configura√ß√£o
 */
function testConfigValidation() {
  var results = { total: 0, passed: 0, failed: 0, errors: [] };

  var tests = [
    {
      name: 'URL v√°lida aceita',
      fn: function() {
        assert(isValidUrl('http://localhost:8000'), 'URL v√°lida n√£o reconhecida');
        assert(isValidUrl('https://api.empresa.com'), 'HTTPS v√°lido n√£o reconhecido');
      }
    },
    {
      name: 'URL inv√°lida rejeitada',
      fn: function() {
        assert(!isValidUrl(''), 'URL vazia aceita');
        assert(!isValidUrl('api.com'), 'URL sem protocolo aceita');
        assert(!isValidUrl(null), 'null aceito');
      }
    },
    {
      name: 'URL normalizada corretamente',
      fn: function() {
        assertEqual(normalizeUrl('http://api.com/'), 'http://api.com', 'Trailing slash n√£o removido');
        assertEqual(normalizeUrl('https://api.com'), 'https://api.com', 'URL sem slash alterada');
      }
    }
  ];

  tests.forEach(function(test) {
    results.total++;
    try {
      test.fn();
      results.passed++;
    } catch (e) {
      results.failed++;
      results.errors.push(test.name + ': ' + e.message);
    }
  });

  return results;
}

/**
 * Testa constru√ß√£o de URLs com filtros
 */
function testUrlBuilding() {
  var results = { total: 0, passed: 0, failed: 0, errors: [] };

  var tests = [
    {
      name: 'URL b√°sica com pagina√ß√£o',
      fn: function() {
        var url = buildQueryUrl('http://api.com/data', null, 1000, 0);
        assert(url.indexOf('limit=1000') !== -1, 'Limit n√£o inclu√≠do');
        assert(url.indexOf('offset=0') !== -1, 'Offset n√£o inclu√≠do');
      }
    },
    {
      name: 'Filtros de data aplicados',
      fn: function() {
        var filters = {
          dateRange: {
            startDate: '20250101',
            endDate: '20250131'
          }
        };
        var url = buildQueryUrl('http://api.com/data', filters, 1000, 0);
        assert(url.indexOf('start_date=2025-01-01') !== -1, 'Start date n√£o convertido');
        assert(url.indexOf('end_date=2025-01-31') !== -1, 'End date n√£o convertido');
      }
    },
    {
      name: 'Limites de seguran√ßa aplicados',
      fn: function() {
        var url = buildQueryUrl('http://api.com/data', null, 999999, -100);
        assert(url.indexOf('limit=1000') !== -1, 'Limit n√£o limitado');
        assert(url.indexOf('offset=0') !== -1, 'Offset negativo n√£o corrigido');
      }
    }
  ];

  tests.forEach(function(test) {
    results.total++;
    try {
      test.fn();
      results.passed++;
    } catch (e) {
      results.failed++;
      results.errors.push(test.name + ': ' + e.message);
    }
  });

  return results;
}

/**
 * Testa transforma√ß√£o de dados
 */
function testDataTransformation() {
  var results = { total: 0, passed: 0, failed: 0, errors: [] };

  var tests = [
    {
      name: 'N√∫mero seguro convertido',
      fn: function() {
        assertEqual(toNumber('123.45', 0), 123.45, 'N√∫mero v√°lido n√£o convertido');
        assertEqual(toNumber('invalid', 0), 0, 'String inv√°lida n√£o retornou default');
        assertEqual(toNumber(null, 10), 10, 'Null n√£o retornou default');
      }
    },
    {
      name: 'String segura sanitizada',
      fn: function() {
        assertEqual(safeValue('test', ''), 'test', 'String v√°lida alterada');
        assertEqual(safeValue(null, 'default'), 'default', 'Null n√£o retornou default');
        assertEqual(safeValue('', 'default'), 'default', 'String vazia n√£o retornou default');
      }
    },
    {
      name: 'Status de pagamento calculado',
      fn: function() {
        var recordPago = { balance_amount: 0, original_amount: 1000, receipts: [{netAmount: 1000}] };
        var recordPendente = { balance_amount: 1000, original_amount: 1000, receipts: [] };

        assertEqual(calculatePaymentStatus(recordPago, true), CONFIG.STATUS_PAID, 'Pago n√£o identificado');
        assertEqual(calculatePaymentStatus(recordPendente, true), CONFIG.STATUS_PENDING, 'Pendente n√£o identificado');
      }
    }
  ];

  tests.forEach(function(test) {
    results.total++;
    try {
      test.fn();
      results.passed++;
    } catch (e) {
      results.failed++;
      results.errors.push(test.name + ': ' + e.message);
    }
  });

  return results;
}

/**
 * Testa mapeamento de campos
 */
function testFieldMapping() {
  var results = { total: 0, passed: 0, failed: 0, errors: [] };

  var tests = [
    {
      name: 'Campos b√°sicos mapeados',
      fn: function() {
        assertEqual(mapLookerFieldToApiParam('company_id'), 'company_id', 'company_id n√£o mapeado');
        assertEqual(mapLookerFieldToApiParam('company_name'), 'company_name', 'company_name n√£o mapeado');
        assertEqual(mapLookerFieldToApiParam('project_id'), 'project_id', 'project_id n√£o mapeado');
      }
    },
    {
      name: 'Campos de contraparte mapeados',
      fn: function() {
        assertEqual(mapLookerFieldToApiParam('cliente_id'), 'client_id', 'cliente_id n√£o mapeado');
        assertEqual(mapLookerFieldToApiParam('credor_id'), 'creditor_id', 'credor_id n√£o mapeado');
      }
    },
    {
      name: 'Campos espec√≠ficos Income/Outcome mapeados',
      fn: function() {
        assertEqual(mapLookerFieldToApiParam('income_periodicity_type'), 'periodicity_type', 'income field n√£o mapeado');
        assertEqual(mapLookerFieldToApiParam('outcome_consistency_status'), 'consistency_status', 'outcome field n√£o mapeado');
      }
    },
    {
      name: 'Campo inexistente retorna null',
      fn: function() {
        assertEqual(mapLookerFieldToApiParam('campo_invalido'), null, 'Campo inv√°lido n√£o retornou null');
      }
    }
  ];

  tests.forEach(function(test) {
    results.total++;
    try {
      test.fn();
      results.passed++;
    } catch (e) {
      results.failed++;
      results.errors.push(test.name + ': ' + e.message);
    }
  });

  return results;
}

/**
 * Testa formata√ß√£o de datas
 */
function testDateFormatting() {
  var results = { total: 0, passed: 0, failed: 0, errors: [] };

  var tests = [
    {
      name: 'Data formatada corretamente',
      fn: function() {
        assertEqual(formatDate('2025-01-15T00:00:00Z'), '20250115', 'Data n√£o formatada');
        assertEqual(formatDate('2025-12-31T23:59:59Z'), '20251231', 'Data fim de ano incorreta');
      }
    },
    {
      name: 'Data inv√°lida retorna vazio',
      fn: function() {
        assertEqual(formatDate('invalid'), '', 'Data inv√°lida n√£o retornou vazio');
        assertEqual(formatDate(null), '', 'Null n√£o retornou vazio');
        assertEqual(formatDate(''), '', 'String vazia n√£o retornou vazio');
      }
    },
    {
      name: 'DateTime formatado corretamente',
      fn: function() {
        assertEqual(formatDateTime('2025-01-15T14:30:00Z'), '2025011514', 'DateTime n√£o formatado');
      }
    }
  ];

  tests.forEach(function(test) {
    results.total++;
    try {
      test.fn();
      results.passed++;
    } catch (e) {
      results.failed++;
      results.errors.push(test.name + ': ' + e.message);
    }
  });

  return results;
}

/**
 * Testa valida√ß√£o de cache
 */
function testCacheValidation() {
  var results = { total: 0, passed: 0, failed: 0, errors: [] };

  var tests = [
    {
      name: 'Cache v√°lido aceito',
      fn: function() {
        var validCache = {
          success: true,
          data: [{ id: 1 }, { id: 2 }]
        };
        assert(validateCachedData(validCache), 'Cache v√°lido rejeitado');
      }
    },
    {
      name: 'Cache inv√°lido rejeitado',
      fn: function() {
        assert(!validateCachedData(null), 'Null aceito');
        assert(!validateCachedData({ data: 'not_array' }), 'Estrutura inv√°lida aceita');
        assert(!validateCachedData({ success: true }), 'Sem data aceito');
      }
    },
    {
      name: 'Limite de tamanho aplicado',
      fn: function() {
        var largeCache = {
          success: true,
          data: new Array(150000) // Mais que o limite de 100k
        };
        assert(!validateCachedData(largeCache), 'Cache muito grande aceito');
      }
    }
  ];

  tests.forEach(function(test) {
    results.total++;
    try {
      test.fn();
      results.passed++;
    } catch (e) {
      results.failed++;
      results.errors.push(test.name + ': ' + e.message);
    }
  });

  return results;
}

/**
 * Testa tratamento de erros
 */
function testErrorHandling() {
  var results = { total: 0, passed: 0, failed: 0, errors: [] };

  var tests = [
    {
      name: 'Mensagens de erro existem',
      fn: function() {
        assert(ERROR_MESSAGES.MISSING_API_URL, 'Mensagem MISSING_API_URL n√£o existe');
        assert(ERROR_MESSAGES.INVALID_API_URL, 'Mensagem INVALID_API_URL n√£o existe');
        assert(ERROR_MESSAGES.API_CONNECTION_FAILED, 'Mensagem API_CONNECTION_FAILED n√£o existe');
      }
    },
    {
      name: 'Mensagens cont√™m ajuda',
      fn: function() {
        assert(ERROR_MESSAGES.INVALID_API_URL.indexOf('Formato esperado') !== -1, 'Sem dica de formato');
        assert(ERROR_MESSAGES.API_CONNECTION_FAILED.indexOf('Verifique') !== -1, 'Sem dica de troubleshooting');
      }
    }
  ];

  tests.forEach(function(test) {
    results.total++;
    try {
      test.fn();
      results.passed++;
    } catch (e) {
      results.failed++;
      results.errors.push(test.name + ': ' + e.message);
    }
  });

  return results;
}

/**
 * Testa c√°lculo de m√©tricas (aging, inadimpl√™ncia)
 */
function testMetricsCalculation() {
  var results = { total: 0, passed: 0, failed: 0, errors: [] };

  var tests = [
    {
      name: 'Dias em atraso calculado corretamente',
      fn: function() {
        // Data vencida h√° 10 dias
        var pastDate = new Date();
        pastDate.setDate(pastDate.getDate() - 10);

        var record = {
          due_date: pastDate.toISOString(),
          balance_amount: 1000
        };

        var dias = getFieldValue(record, 'dias_atraso', true, true, 'due_date');
        assert(dias >= 9 && dias <= 11, 'Dias em atraso incorreto: ' + dias); // Toler√¢ncia de 1 dia
      }
    },
    {
      name: 'Taxa de inadimpl√™ncia calculada',
      fn: function() {
        var record = {
          original_amount: 1000,
          balance_amount: 300
        };

        var taxa = getFieldValue(record, 'taxa_inadimplencia', true, true, 'due_date');
        assertEqual(taxa, 30, 'Taxa incorreta: esperado 30%, got ' + taxa);
      }
    },
    {
      name: 'Faixa de aging classificada',
      fn: function() {
        var pastDate = new Date();
        pastDate.setDate(pastDate.getDate() - 45);

        var record = {
          due_date: pastDate.toISOString(),
          balance_amount: 1000
        };

        var faixa = getFieldValue(record, 'faixa_aging', true, true, 'due_date');
        assertEqual(faixa, '31-60 dias', 'Faixa incorreta: ' + faixa);
      }
    }
  ];

  tests.forEach(function(test) {
    results.total++;
    try {
      test.fn();
      results.passed++;
    } catch (e) {
      results.failed++;
      results.errors.push(test.name + ': ' + e.message);
    }
  });

  return results;
}
